<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Reservations</title>
</head>
<body>
<nav style="margin-bottom:12px">
  <a href="index.html">Home</a> |
  <a href="albums.html">Albums</a> |
  <a href="reservations.html">Reservations</a> |
  <a href="stores.html">Stores</a>
</nav>
<label>Customer ID: <input id="cid" value="1" size="6"></label>
<label><input type="checkbox" id="onlyAvail"> Only available now</label>
<button id="load">Load</button>
<div id="msg" style="color:#b00"></div>

<h3>Register / Unregister</h3>
<form id="regForm">
  <input name="albumId" placeholder="Album ID" required>
  <button data-action="register">Register interest</button>
  <button data-action="unregister" type="button">Unregister</button>
</form>

<h3>My reservations</h3>
<table border="1" cellpadding="6">
  <thead><tr><th>Res ID</th><th>Album</th><th>Artist</th><th>Available</th><th>Status</th><th>Action</th></tr></thead>
  <tbody id="rows"></tbody>
</table>

<script type="module">
    // Serve from same origin as Spring Boot:
    const API = ''; // same-origin base

    const cid = document.querySelector('#cid');
    const only = document.querySelector('#onlyAvail');
    const rows = document.querySelector('#rows');
    const msg = document.querySelector('#msg');

    const showErr = e => {
        msg.textContent = e.message || String(e);
        setTimeout(() => (msg.textContent = ''), 2500);
    };

    async function fetchJson(url, opts) {
        const r = await fetch(API + url, {
            headers: { 'Content-Type': 'application/json' },
            ...opts
        });
        if (!r.ok) {
            const text = await r.text();
            throw new Error(text || `HTTP ${r.status}`);
        }
        const text = await r.text();
        return text ? JSON.parse(text) : null;
    }

    async function load() {
        try {
            const data = await fetchJson(`/reservations/customer/${encodeURIComponent(cid.value)}?onlyAvailable=${only.checked}`);
            rows.innerHTML = (data || []).map(r => {
                const a = r.album || {};
                const status = r.active ? 'INTERESTED' : 'CANCELLED';
                return `
          <tr data-album-id="${a.id ?? ''}">
            <td>${r.id ?? ''}</td>
            <td>${a.title ?? ''}</td>
            <td>${a.artist ?? ''}</td>
            <td>${a.available ? 'Yes' : 'No'}</td>
            <td>${status}</td>
            <td>
              ${r.active
                    ? `<button class="unreg">Unregister</button>`
                    : `<em>â€”</em>`}
            </td>
          </tr>`;
            }).join('');
        } catch (e) { showErr(e); }
    }

    document.querySelector('#load').addEventListener('click', e => {
        e.preventDefault();
        load();
    });

    // Register from form
    document.querySelector('#regForm').addEventListener('submit', async e => {
        e.preventDefault();
        const albumId = new FormData(e.target).get('albumId');
        if (!albumId) return;
        try {
            await fetchJson(`/reservations/register?customerId=${encodeURIComponent(cid.value)}&albumId=${encodeURIComponent(albumId)}`, { method: 'POST' });
            e.target.reset();
            load();
        } catch (e) { showErr(e); }
    });

    // Unregister from the form button (by Album ID)
    document.querySelector('#regForm [data-action="unregister"]').addEventListener('click', async () => {
        const albumId = document.querySelector('#regForm [name="albumId"]').value;
        if (!albumId) return;
        try {
            await fetchJson(`/reservations/unregister?customerId=${encodeURIComponent(cid.value)}&albumId=${encodeURIComponent(albumId)}`, { method: 'POST' });
            load();
        } catch (e) { showErr(e); }
    });

    // Unregister from table row button
    rows.addEventListener('click', async e => {
        if (!e.target.classList.contains('unreg')) return;
        const tr = e.target.closest('tr');
        const albumId = tr?.dataset?.albumId;
        if (!albumId) return;
        try {
            await fetchJson(`/reservations/unregister?customerId=${encodeURIComponent(cid.value)}&albumId=${encodeURIComponent(albumId)}`, { method: 'POST' });
            load();
        } catch (e) { showErr(e); }
    });

    load();
</script>

</body>
</html>
