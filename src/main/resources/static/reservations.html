<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Reservations</title>
</head>
<body>
<nav style="margin-bottom:12px">
  <a href="index.html">Home</a> |
  <a href="albums.html">Albums</a> |
  <a href="reservations.html">Reservations</a> |
  <a href="stores.html">Stores</a>
</nav>

<!-- Customer & Album selection -->
<div style="display:flex; gap:12px; align-items:flex-end; flex-wrap:wrap; margin-bottom:10px">
  <div>
    <label for="customerSelect"><strong>Customer</strong></label><br>
    <select id="customerSelect">
      <option value="">— choose customer —</option>
    </select>
  </div>

  <div>
    <label for="albumSelect"><strong>Album</strong></label><br>
    <select id="albumSelect">
      <option value="">— choose album —</option>
    </select>
  </div>

  <div>
    <label><input type="checkbox" id="onlyAvail"> Only available now</label><br>
    <button id="load">Load</button>
  </div>
</div>

<!-- Selected customer info (id is hidden but used by API) -->
<input id="cid" type="hidden" value="">
<div id="custInfo" style="margin:-6px 0 10px 0;color:#333">Selected: —</div>

<div id="msg" style="color:#b00"></div>

<h3>Register / Unregister</h3>
<form id="regForm">
  <!-- album is taken from albumSelect -->
  <button data-action="register">Register interest</button>
  <button data-action="unregister" type="button">Unregister</button>
</form>

<h3>My reservations</h3>
<table border="1" cellpadding="6">
  <thead><tr><th>Res ID</th><th>Album</th><th>Artist</th><th>Available</th><th>Status</th><th>Action</th></tr></thead>
  <tbody id="rows"></tbody>
</table>

<script type="module">
    const API = ''; // same-origin (Spring serves /static)

    const customerSelect = document.querySelector('#customerSelect');
    const albumSelect = document.querySelector('#albumSelect');
    const cid = document.querySelector('#cid');
    const only = document.querySelector('#onlyAvail');
    const rows = document.querySelector('#rows');
    const msg = document.querySelector('#msg');
    const custInfo = document.querySelector('#custInfo');

    const showErr = e => { msg.textContent = e.message || String(e); setTimeout(() => msg.textContent = '', 2500); };

    async function fetchJson(url, opts) {
        const r = await fetch(API + url, { headers: { 'Content-Type': 'application/json' }, ...opts });
        if (!r.ok) throw new Error((await r.text()) || `HTTP ${r.status}`);
        const t = await r.text();
        return t ? JSON.parse(t) : null;
    }

    function setSelectedCustomer(c) {
        cid.value = c?.id ?? '';
        custInfo.textContent = c
            ? `Selected: ${c.name ?? ''} <${c.email ?? ''}> [id ${c.id}]`
            : 'Selected: —';
    }

    async function populateCustomers() {
        const list = await fetchJson('/customers/search?q=');
        customerSelect.innerHTML = `<option value="">— choose customer —</option>` +
            (list || []).map(c => `<option value="${c.id}">${escapeHtml(c.name || '(no name)')} — ${escapeHtml(c.email || '')}</option>`).join('');
        // Auto-select first customer for convenience
        if (list && list.length) {
            customerSelect.value = String(list[0].id);
            setSelectedCustomer(list[0]);
        }
    }

    async function populateAlbums() {
        // Your AlbumRestController lists at /albums/ (with trailing slash)
        const list = await fetchJson('/albums/');
        albumSelect.innerHTML = `<option value="">— choose album —</option>` +
            (list || []).map(a => {
                const text = a.title ? (a.artist ? `${a.title} — ${a.artist}` : a.title) : '(untitled)';
                return `<option value="${a.id}">${escapeHtml(text)}</option>`;
            }).join('');
    }

    function escapeHtml(s) {
        return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    async function loadReservations() {
        if (!cid.value) { rows.innerHTML = ''; return; }
        try {
            const data = await fetchJson(`/reservations/customer/${encodeURIComponent(cid.value)}?onlyAvailable=${only.checked}`);
            rows.innerHTML = (data || []).map(r => {
                const a = r.album || {};
                const status = r.active ? 'INTERESTED' : 'CANCELLED';
                return `
          <tr data-album-id="${a.id ?? ''}">
            <td>${r.id ?? ''}</td>
            <td>${a.title ?? ''}</td>
            <td>${a.artist ?? ''}</td>
            <td>${a.available ? 'Yes' : 'No'}</td>
            <td>${status}</td>
            <td>${r.active ? `<button class="unreg">Unregister</button>` : `<em>—</em>`}</td>
          </tr>`;
            }).join('');
        } catch (e) { showErr(e); }
    }

    document.querySelector('#load').addEventListener('click', e => (e.preventDefault(), loadReservations()));

    customerSelect.addEventListener('change', async () => {
        const id = customerSelect.value;
        if (!id) { setSelectedCustomer(null); rows.innerHTML=''; return; }
        try {
            const c = await fetchJson(`/customers/${encodeURIComponent(id)}`);
            setSelectedCustomer(c);
            loadReservations();
        } catch (e) { showErr(e); }
    });

    document.querySelector('#regForm').addEventListener('submit', async e => {
        e.preventDefault();
        const customerId = cid.value;
        const albumId = albumSelect.value;
        if (!customerId || !albumId) return showErr(new Error('Choose a customer and an album first.'));
        try {
            await fetchJson(`/reservations/register?customerId=${encodeURIComponent(customerId)}&albumId=${encodeURIComponent(albumId)}`, { method: 'POST' });
            loadReservations();
        } catch (e2) { showErr(e2); }
    });

    document.querySelector('#regForm [data-action="unregister"]').addEventListener('click', async () => {
        const customerId = cid.value;
        const albumId = albumSelect.value;
        if (!customerId || !albumId) return showErr(new Error('Choose a customer and an album first.'));
        try {
            await fetchJson(`/reservations/unregister?customerId=${encodeURIComponent(customerId)}&albumId=${encodeURIComponent(albumId)}`, { method: 'POST' });
            loadReservations();
        } catch (e) { showErr(e); }
    });

    rows.addEventListener('click', async e => {
        if (!e.target.classList.contains('unreg')) return;
        const tr = e.target.closest('tr');
        const albumId = tr?.dataset?.albumId;
        const customerId = cid.value;
        if (!albumId || !customerId) return;
        try {
            await fetchJson(`/reservations/unregister?customerId=${encodeURIComponent(customerId)}&albumId=${encodeURIComponent(albumId)}`, { method: 'POST' });
            loadReservations();
        } catch (e) { showErr(e); }
    });

    // Boot
    (async function init() {
        try {
            await Promise.all([populateCustomers(), populateAlbums()]);
            await loadReservations();
        } catch (e) { showErr(e); }
    })();
</script>

</body>
</html>
